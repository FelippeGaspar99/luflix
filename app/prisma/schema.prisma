generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  EMPLOYEE
}

enum VideoProgressStatus {
  IN_PROGRESS
  COMPLETED
}

model User {
  id            String          @id @default(cuid())
  name          String
  username      String          @unique
  email         String?         @unique
  passwordHash  String
  role          UserRole        @default(EMPLOYEE)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  createdModules Module[]       @relation("ModuleCreator")
  accesses      ModuleAccess[]
  progresses    VideoProgress[]
  certificates  Certificate[]
}

model Module {
  id           String           @id @default(cuid())
  title        String
  description  String
  coverUrl     String
  isPublished  Boolean          @default(true)
  isMembersVisible Boolean      @default(false)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  createdById  String
  creator      User             @relation("ModuleCreator", fields: [createdById], references: [id])
  videos       Video[]
  accesses     ModuleAccess[]
  certificates Certificate[]
}

model Video {
  id          String       @id @default(cuid())
  moduleId    String
  module      Module       @relation(fields: [moduleId], references: [id])
  title       String
  description String
  videoUrl    String
  thumbnailUrl String?
  attachmentUrl String?
  sortOrder   Int          @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  progresses  VideoProgress[]
}

model ModuleAccess {
  id        String   @id @default(cuid())
  moduleId  String
  userId    String
  createdAt DateTime @default(now())
  module    Module   @relation(fields: [moduleId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([moduleId, userId])
}

model VideoProgress {
  id          String               @id @default(cuid())
  userId      String
  videoId     String
  status      VideoProgressStatus  @default(IN_PROGRESS)
  progress    Float                @default(0)
  completedAt DateTime?
  updatedAt   DateTime             @updatedAt
  createdAt   DateTime             @default(now())
  user        User                 @relation(fields: [userId], references: [id])
  video       Video                @relation(fields: [videoId], references: [id])

  @@unique([userId, videoId])
}

model Certificate {
  id        String   @id @default(cuid())
  userId    String
  moduleId  String
  filePath  String
  issuedAt  DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
  module    Module   @relation(fields: [moduleId], references: [id])

  @@unique([userId, moduleId])
}

model VideoConfig {
  id        Int      @id @default(autoincrement())
  videoUrl  String   @map("video_url") @db.VarChar(500)
  posterUrl String?  @map("poster_url") @db.VarChar(500)

  @@map("video_config")
}
